# 英作文システムの難易度別生成と重複回避機能

## 概要

瞬間英作文モードに難易度別問題生成機能と重複回避システムを実装しました。これにより、学習者のレベルに適した問題を継続的に提供でき、同じ問題の重複を避けて効率的な学習環境を構築できます。

## 実装した機能

### 1. 難易度別問題生成システム

#### バックエンド機能
- **リクエストモデルの拡張**: `InstantTranslationRequest`を追加
  - `difficulty`: "easy", "medium", "hard", "all"から選択
  - `category`: カテゴリフィルター（天気、日常生活、ビジネスなど）
  - `exclude_problems`: 除外問題IDリスト

#### フロントエンド機能
- **設定パネル**: 難易度とカテゴリを選択できるUI
- **問題情報表示**: 各問題の難易度とカテゴリをバッジで表示
- **リアルタイム適用**: 設定変更後すぐに新しい問題を取得

### 2. 重複回避システム

#### 履歴管理機能
- **問題履歴の記録**: 過去に出題された問題のIDを保存
- **除外リストの自動生成**: 過去10問のIDを自動的に除外
- **セッション管理**: ユーザーごとの履歴管理（現在は簡易実装）

#### インテリジェントな問題選択
1. **フィルタリング処理**:
   - 指定された難易度での絞り込み
   - カテゴリでの絞り込み
   - 過去10問との重複除外

2. **フォールバック機能**:
   - 利用可能な問題がない場合の履歴リセット
   - AI生成問題への自動切り替え
   - 最終的にはすべての問題からランダム選択

### 3. AI問題生成システム

#### 動的問題生成
- **コンテキスト指定**: 難易度とカテゴリに基づいた問題生成
- **プロンプト最適化**: 日本人学習者向けの自然な問題作成
- **回答抽出**: 正規表現を使用した日本語・英語ペアの抽出

#### 生成条件
- **難易度別の文法レベル**:
  - Easy: 現在形、過去形、基本的な日常表現
  - Medium: 複合時制、関係代名詞、やや複雑な文構造
  - Hard: 仮定法、複雑な文法構造、ビジネス表現

- **カテゴリ別の語彙選択**:
  - 天気、日常生活、ビジネス、旅行、食べ物など
  - 学習者にとって実用的な表現を重視

## 技術的な工夫

### 1. メモリ効率的な履歴管理

```javascript
// 過去10問のIDを除外リストに追加（重複回避）
const excludeProblems = problemHistory.slice(-10).map(p => p.problemId).filter(Boolean);
```

- **循環バッファー的な管理**: 最新10問のみを追跡
- **メモリリーク防止**: 無制限な履歴蓄積を回避
- **フィルタリング効率**: Boolean変換で無効IDを除外

### 2. グレースフルデグラデーション

```python
# 利用可能な問題がない場合の処理
if not available_problems:
    if filtered_problems:
        # 履歴をクリアして再利用
        problem_history[session_id] = []
        available_problems = filtered_problems
    else:
        # AI生成を試行
        ai_problem = await generate_ai_problem(req.difficulty, req.category)
        if ai_problem:
            return ai_problem
        else:
            # 最終的にはランダム選択
            available_problems = TRANSLATION_PROBLEMS.copy()
```

- **段階的フォールバック**: 複数の代替手段を用意
- **サービス継続性**: AI生成失敗時でも問題提供を継続
- **ユーザー体験の維持**: エラーによる学習中断を回避

### 3. レスポンシブな設定UI

```css
.settings-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}

@media (max-width: 768px) {
  .settings-grid {
    grid-template-columns: 1fr;
  }
}
```

- **CSS Grid活用**: 設定項目の整理された配置
- **モバイル対応**: 画面サイズに応じたレイアウト調整
- **視覚的フィードバック**: 難易度・カテゴリバッジでの情報提示

### 4. 問題データの構造化

```python
{
    "id": "easy_001",
    "japanese": "今日は天気がいいですね。",
    "english": "It's nice weather today.",
    "difficulty": "easy",
    "category": "weather"
}
```

- **ID付与**: 重複回避のための一意識別子
- **メタデータ拡張**: 難易度とカテゴリ情報の構造化
- **拡張性確保**: 新しい属性追加が容易な設計

## ユーザビリティの向上

### 1. 直感的な設定操作
- **ワンクリック設定**: 設定パネルの簡単な開閉
- **即時適用**: 設定変更後の自動問題更新
- **視覚的フィードバック**: バッジによる現在の設定確認

### 2. 学習継続性の向上
- **重複回避**: 同じ問題の連続出題防止
- **段階的学習**: 難易度による体系的スキルアップ
- **カテゴリ特化**: 特定分野の集中学習サポート

### 3. 情報の透明性
- **問題情報表示**: 各問題の難易度・カテゴリ表示
- **進捗確認**: 正解率の継続的表示
- **履歴管理**: 学習履歴のクリア機能

## 拡張可能性

### 1. データベース連携
- **現在**: メモリ内での簡易セッション管理
- **将来**: Redis/PostgreSQLでの永続化

### 2. ユーザー認証との統合
- **現在**: デフォルトセッションでの管理
- **将来**: 個別ユーザーアカウントとの連携

### 3. 学習分析機能
- **現在**: 基本的な正解率表示
- **将来**: 詳細な学習パターン分析とレコメンデーション

### 4. 問題データの拡張
- **現在**: 15問の基本セット + AI生成
- **将来**: 大規模問題データベースとの連携

## まとめ

本実装により、瞬間英作文モードは単なる問題出題システムから、学習者の進度に応じたインテリジェントな学習支援システムへと進化しました。重複回避機能により学習効率が向上し、難易度選択により個人のレベルに最適化された学習環境を提供できるようになりました。

また、AI生成機能により問題リソースの制約を突破し、無限に近い問題バリエーションを実現しています。これらの工夫により、継続的で効果的な英語学習体験を提供できます。