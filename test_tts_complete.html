<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS Test Complete</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>English Communication App - TTS Test</h1>
    
    <div class="test-section">
        <h3>Backend API Status</h3>
        <button onclick="checkAPIStatus()">Check API Status</button>
        <div id="apiStatus" class="status info">Click to check API status</div>
    </div>

    <div class="test-section">
        <h3>Text-to-Speech Test</h3>
        <textarea id="testText" placeholder="Enter text to speak...">Hello! This is a test of the Gemini text-to-speech system. How are you doing today?</textarea>
        <br>
        <label>Speaking Rate: <input type="range" id="speakingRate" min="0.5" max="2.0" step="0.1" value="1.0"> <span id="rateValue">1.0</span></label>
        <br>
        <button onclick="testGeminiTTS()">Test Gemini TTS</button>
        <button onclick="testBrowserTTS()">Test Browser TTS</button>
        <button onclick="stopSpeech()">Stop All Speech</button>
        <div id="ttsStatus" class="status info">Ready to test TTS</div>
    </div>

    <div class="test-section">
        <h3>Test Results</h3>
        <div id="testResults" class="status info">No tests run yet</div>
    </div>

    <script>
        // Update speaking rate display
        document.getElementById('speakingRate').addEventListener('input', function() {
            document.getElementById('rateValue').textContent = this.value;
        });

        // Stop all speech
        function stopSpeech() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            // Stop any playing audio elements
            document.querySelectorAll('audio').forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
            updateStatus('ttsStatus', 'All speech stopped', 'info');
        }

        // Update status display
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Check API status
        async function checkAPIStatus() {
            try {
                updateStatus('apiStatus', 'Checking API status...', 'info');
                
                const response = await fetch('http://localhost:8000/api/status');
                const data = await response.json();
                
                let statusMessage = `API Status:\n`;
                statusMessage += `- Gemini configured: ${data.gemini_configured}\n`;
                statusMessage += `- Google credentials: ${data.google_credentials_configured}\n`;
                statusMessage += `- Gemini TTS configured: ${data.gemini_tts_configured}\n`;
                statusMessage += `- TTS configured: ${data.tts_configured}`;
                
                const allGood = data.gemini_configured && data.google_credentials_configured && 
                              data.gemini_tts_configured && data.tts_configured;
                
                updateStatus('apiStatus', statusMessage, allGood ? 'success' : 'error');
            } catch (error) {
                updateStatus('apiStatus', `Error checking API: ${error.message}`, 'error');
            }
        }

        // Test Gemini TTS
        async function testGeminiTTS() {
            const text = document.getElementById('testText').value;
            const rate = parseFloat(document.getElementById('speakingRate').value);
            
            if (!text.trim()) {
                updateStatus('ttsStatus', 'Please enter some text to speak', 'error');
                return;
            }

            try {
                updateStatus('ttsStatus', 'Testing Gemini TTS...', 'info');
                
                const response = await fetch('http://localhost:8000/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        voice_name: 'kore',
                        language_code: 'en-US',
                        speaking_rate: rate
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.use_browser_tts) {
                    updateStatus('ttsStatus', 'Gemini TTS requested browser fallback', 'error');
                    updateStatus('testResults', 'Gemini TTS failed - using browser fallback', 'error');
                    return;
                }

                if (!data.audio_data) {
                    throw new Error('No audio data received from server');
                }

                // Create audio element and play
                const audioData = data.audio_data;
                const audioBlob = base64ToBlob(audioData, data.content_type || 'audio/wav');
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    updateStatus('ttsStatus', 'Gemini TTS playback completed successfully!', 'success');
                    updateStatus('testResults', 'Gemini TTS test PASSED ✓', 'success');
                };
                
                audio.onerror = (error) => {
                    URL.revokeObjectURL(audioUrl);
                    updateStatus('ttsStatus', `Audio playback error: ${error.message}`, 'error');
                    updateStatus('testResults', 'Gemini TTS test FAILED ✗', 'error');
                };
                
                await audio.play();
                updateStatus('ttsStatus', 'Playing Gemini TTS audio...', 'info');
                
            } catch (error) {
                updateStatus('ttsStatus', `Gemini TTS error: ${error.message}`, 'error');
                updateStatus('testResults', 'Gemini TTS test FAILED ✗', 'error');
            }
        }

        // Test Browser TTS
        function testBrowserTTS() {
            const text = document.getElementById('testText').value;
            const rate = parseFloat(document.getElementById('speakingRate').value);
            
            if (!text.trim()) {
                updateStatus('ttsStatus', 'Please enter some text to speak', 'error');
                return;
            }

            if (!('speechSynthesis' in window)) {
                updateStatus('ttsStatus', 'Browser TTS not supported', 'error');
                updateStatus('testResults', 'Browser TTS test FAILED ✗ - Not supported', 'error');
                return;
            }

            try {
                updateStatus('ttsStatus', 'Testing Browser TTS...', 'info');
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rate;
                
                utterance.onend = () => {
                    updateStatus('ttsStatus', 'Browser TTS completed successfully!', 'success');
                    updateStatus('testResults', 'Browser TTS test PASSED ✓', 'success');
                };
                
                utterance.onerror = (error) => {
                    updateStatus('ttsStatus', `Browser TTS error: ${error.error}`, 'error');
                    updateStatus('testResults', 'Browser TTS test FAILED ✗', 'error');
                };
                
                speechSynthesis.speak(utterance);
                updateStatus('ttsStatus', 'Playing Browser TTS audio...', 'info');
                
            } catch (error) {
                updateStatus('ttsStatus', `Browser TTS error: ${error.message}`, 'error');
                updateStatus('testResults', 'Browser TTS test FAILED ✗', 'error');
            }
        }

        // Helper function to convert base64 to blob
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // Auto-check API status on load
        window.addEventListener('load', checkAPIStatus);
    </script>
</body>
</html>